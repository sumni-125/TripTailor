<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>마이페이지</title>
    <link rel="stylesheet" th:href="@{/css/header.css}" />
</head>
<body>
<header th:replace="~{fragments/header :: headerFragment}"></header>

<p>마이페이지입니다</p>
<button id="deleteBtn">회원 탈퇴</button>

<!-- ✅ CSRF 토큰 Thymeleaf에서 자동 주입 -->
<input type="hidden" id="csrfToken" th:value="${_csrf.token}" />
<input type="hidden" id="csrfHeader" th:value="${_csrf.headerName}" />

<script>
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (confirm("정말 탈퇴하시겠습니까?")) {

        const csrfToken = document.getElementById("csrfToken").value;
        const csrfHeader = document.getElementById("csrfHeader").value;

        const res = await fetch("/deleteaccount", {
          method: "DELETE",
          headers: {
            [csrfHeader]: csrfToken  // ✅ CSRF 헤더 추가
          }
        });

        const text = await res.text();

        if (text === "redirect") {
          alert("회원탈퇴가 완료되었습니다.");
          window.location.href = "/main"; // ✅ JS에서 수동 이동
        } else {
          alert("탈퇴 중 오류가 발생했습니다.");
        }
      }
    });
</script>

</body>
</html>
